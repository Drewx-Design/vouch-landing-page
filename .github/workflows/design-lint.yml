# Design Linter CI Test
#
# Runs design linting on Vercel preview deployments.
# Fails the build if design errors are found.

name: Design Lint

on:
  deployment_status:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to analyze'
        required: true
        type: string
      fail_on_warnings:
        description: 'Fail build on warnings too'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: write

jobs:
  design-lint:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout design linter
        uses: actions/checkout@v4
        with:
          repository: Drewx-Design/Prompt_Theory
          token: ${{ secrets.DESIGN_LINTER_TOKEN }}
          path: design-linter

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: design-linter/package-lock.json

      - name: Install dependencies
        working-directory: design-linter
        run: npm ci

      - name: Build extension and CLI
        working-directory: design-linter
        run: |
          npm run build:dev
          npm run cli:build

      - name: Determine URL
        id: url
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "url=${{ github.event.inputs.url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ github.event.deployment_status.target_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Design Linter
        id: lint
        working-directory: design-linter
        continue-on-error: true
        run: |
          URL="${{ steps.url.outputs.url }}"

          # Run linter, capture output
          npm run cli:run -- "$URL" --verbose > ../results.sarif 2>../lint.log || EXIT_CODE=$?

          # Parse results
          if [ -f ../results.sarif ] && grep -q '"results"' ../results.sarif; then
            ERROR_COUNT=$(jq '[.runs[0].results[] | select(.level == "error")] | length' ../results.sarif)
            WARNING_COUNT=$(jq '[.runs[0].results[] | select(.level == "warning")] | length' ../results.sarif)
            TOTAL=$((ERROR_COUNT + WARNING_COUNT))

            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "sarif_valid=true" >> $GITHUB_OUTPUT
          else
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "warning_count=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "sarif_valid=false" >> $GITHUB_OUTPUT
            cat ../lint.log || true
          fi

      - name: Upload SARIF to Code Scanning
        if: steps.lint.outputs.sarif_valid == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: design-linter

      - name: Test Results Summary
        if: always()
        run: |
          ERRORS="${{ steps.lint.outputs.error_count }}"
          WARNINGS="${{ steps.lint.outputs.warning_count }}"
          TOTAL="${{ steps.lint.outputs.total }}"
          URL="${{ steps.url.outputs.url }}"

          if [ "$ERRORS" -gt 0 ]; then
            echo "## ❌ Design Lint Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ Design Lint Passed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analyzed:** $URL" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          ERRORS="${{ steps.lint.outputs.error_count }}"
          FAIL_ON_WARNINGS="${{ github.event.inputs.fail_on_warnings }}"
          WARNINGS="${{ steps.lint.outputs.warning_count }}"

          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Design lint found $ERRORS error(s)"
            exit 1
          fi

          if [ "$FAIL_ON_WARNINGS" == "true" ] && [ "$WARNINGS" -gt 0 ]; then
            echo "::error::Design lint found $WARNINGS warning(s) (fail_on_warnings enabled)"
            exit 1
          fi

          echo "Design lint passed!"
